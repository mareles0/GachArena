<div class="gacha-home-container">

    <img src="https://i.pinimg.com/originals/c6/a1/c9/c6a1c9f91f82c3fe5af6c5d83cc0bf7e.gif" class="bg-gif" alt="" aria-hidden="true">
     
    <video autoplay muted loop class="bg-video">
        <source src="assets/backgrounds/welcome.webm" type="video/webm">
        <source src="assets/backgrounds/welcome.mp4" type="video/mp4">
    </video>


  <div class="notification-toast" *ngIf="notification.show" 
       [class.success]="notification.type === 'success'"
       [class.error]="notification.type === 'error'"
       [class.info]="notification.type === 'info'">
    <i class="bi" [class.bi-check-circle-fill]="notification.type === 'success'"
                   [class.bi-x-circle-fill]="notification.type === 'error'"
                   [class.bi-info-circle-fill]="notification.type === 'info'"></i>
    <span>{{ notification.message }}</span>
    <button class="close-btn" (click)="notification.show = false">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading && !selectedBox" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-3">Carregando caixas...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && boxes.length === 0" class="empty-state">
    <i class="bi bi-inbox" style="font-size: 5rem; color: #ccc;"></i>
    <h3>Nenhuma caixa disponível</h3>
    <p>O administrador ainda não cadastrou caixas no sistema.</p>
    <p class="text-muted">Peça ao admin para popular o banco de dados em "Admin → Gerenciar Caixas"</p>
  </div>

  <!-- Grade de Caixas -->
  <div class="boxes-grid" *ngIf="!loading && boxes.length > 0">
    <div class="box-card" *ngFor="let box of boxes" 
         [class.normal-box]="box.type === 'NORMAL'" 
         [class.premium-box]="box.type === 'PREMIUM'"
         (click)="selectBox(box)">
      <div class="box-image">
        <img [src]="box.imageUrl" [alt]="box.name">
        <div class="box-type-badge" [class.premium]="box.type === 'PREMIUM'">
          {{ box.type === 'NORMAL' ? 'NORMAL' : 'PREMIUM' }}
        </div>
      </div>
      <div class="box-info">
        <h3>{{ box.name }}</h3>
        <p>{{ box.description }}</p>
      </div>
    </div>
  </div>

  <!-- Modal de Abertura de Caixa -->
  <div class="modal-overlay" *ngIf="selectedBox" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      
      <!-- Resultado -->
      <div class="box-result" *ngIf="showResult">
        <!-- Resultado Único -->
        <div class="result-card" *ngIf="openMode === 'single' && drawnItem" [style.border-color]="getRarityColor(drawnItem.rarity)">
          <div class="rarity-glow" [style.background]="getRarityColor(drawnItem.rarity)"></div>
          <img [src]="drawnItem.imageUrl" [alt]="drawnItem.name" class="item-image">
          <h2>{{ drawnItem.name }}</h2>
          <div class="rarity-badge" [ngClass]="getRarityClass(drawnItem.rarity)">
            {{ drawnItem.rarity }}
          </div>
          <div class="item-stats">
            <span class="power-stat">
              <i class="bi bi-lightning-fill"></i> Poder: {{ drawnItem.power }}
            </span>
          </div>
          <button class="btn btn-success mt-3" (click)="closeModal()">
            <i class="bi bi-check-circle"></i> Continuar
          </button>
        </div>

        <!-- Resultado Múltiplo -->
        <div class="multi-result" *ngIf="openMode === 'multi'">
          <h2 class="multi-title" *ngIf="revealedMultiResults.length < multiResults.length">
            <i class="bi bi-trophy-fill"></i>
            Item {{ currentMultiIndex + 1 }} de {{ multiResults.length }}
          </h2>
          <h2 class="multi-title" *ngIf="revealedMultiResults.length === multiResults.length">
            <i class="bi bi-trophy-fill"></i>
            Multi Abertura Concluída!
          </h2>
          <p class="multi-subtitle" *ngIf="revealedMultiResults.length < multiResults.length">Clique no item para continuar</p>
          <p class="multi-subtitle" *ngIf="revealedMultiResults.length === multiResults.length">Você ganhou {{ multiResults.length }} itens!</p>
          
          <!-- Modo de visualização sequencial (um item por vez) -->
          <div class="current-item-display" *ngIf="revealedMultiResults.length < multiResults.length && revealedMultiResults.length > 0">
            <div class="result-card" 
                 [style.border-color]="getRarityColor(revealedMultiResults[0].rarity)"
                 [style.--rarity-color]="getRarityColor(revealedMultiResults[0].rarity)"
                 [style.--rarity-glow]="getRarityColor(revealedMultiResults[0].rarity)"
                 [ngClass]="{
                   'item-exiting': isItemTransitioning, 
                   'item-entering': !isItemTransitioning && currentMultiIndex > 0, 
                   'first-item': currentMultiIndex === 0,
                   'card-revealing': !isItemTransitioning && currentMultiIndex >= 0
                 }"
                 (click)="nextMultiItem()">
              <div class="rarity-glow" [style.background]="getRarityColor(revealedMultiResults[0].rarity)"></div>
              <img [src]="revealedMultiResults[0].imageUrl" 
                   [alt]="revealedMultiResults[0].name" 
                   class="item-image">
              <h2>{{ revealedMultiResults[0].name }}</h2>
              <div class="rarity-badge" [ngClass]="getRarityClass(revealedMultiResults[0].rarity)">
                {{ revealedMultiResults[0].rarity }}
              </div>
              <div class="item-stats">
                <span class="power-stat">
                  <i class="bi bi-lightning-fill"></i> Poder: {{ revealedMultiResults[0].power }}
                </span>
              </div>
            </div>
          </div>

          <!-- Modo de visualização completa (todos os itens) -->
          <div class="multi-items-grid" *ngIf="revealedMultiResults.length === multiResults.length" #multiGrid>
            <div class="multi-item-card" *ngFor="let item of revealedMultiResults; let i = index" [style.border-color]="getRarityColor(item.rarity)" [style.animationDelay]="(i * 0.12) + 's'" [style.animationFillMode]="'forwards'">
              <div class="rarity-glow" [style.background]="getRarityColor(item.rarity)"></div>
              <img [src]="item.imageUrl" [alt]="item.name" class="multi-item-image">
              <div class="multi-item-info">
                <h4 [ngClass]="getRarityClass(item.rarity)">{{ item.name }}</h4>
                <span class="rarity-badge" [ngClass]="getRarityClass(item.rarity)">
                  {{ item.rarity }}
                </span>
                <span class="power-stat">
                  <i class="bi bi-lightning-fill"></i> {{ item.power }}
                </span>
              </div>
            </div>
          </div>

          <button class="btn btn-success mt-4" (click)="closeModal()" *ngIf="currentMultiIndex >= multiResults.length - 1 || revealedMultiResults.length === multiResults.length">
            <i class="bi bi-check-circle"></i> Continuar
          </button>
        </div>
      </div>

      <!-- Preview da Caixa -->
      <div class="box-preview" *ngIf="!showResult">
        <button class="close-btn" (click)="closeModal()">
          <i class="bi bi-x-lg"></i>
        </button>
        
        <div class="preview-header">
          <h2>{{ selectedBox.name }}</h2>
          <span class="box-type" [class.premium]="selectedBox.type === 'PREMIUM'">
            {{ selectedBox.type }}
          </span>
        </div>

        <div class="preview-image">
          <img [src]="selectedBox.imageUrl" [alt]="selectedBox.name">
        </div>

        <p class="preview-description">{{ selectedBox.description }}</p>

        

        <!-- Opções de Abertura -->
        <div class="open-options">
          <div class="option-tabs">
            <button class="option-tab" 
                    [class.active]="openMode === 'single'"
                    (click)="setOpenMode('single')">
              <span>1</span>
              <small>
                <img src="https://static.wikitide.net/cravesagawiki/{{ selectedBox.type === 'NORMAL' ? '4/46/Platinum_Gacha_Ticket.png' : 'f/fe/SR_or_Higher_Gacha_Ticket.png' }}" 
                     alt="Ticket" class="ticket-icon-small">
              </small>
            </button>
            <button class="option-tab" 
                    [class.active]="openMode === 'multi'"
                    (click)="setOpenMode('multi')">
              <span>{{ selectedBox.type === 'NORMAL' ? '10' : '5' }}</span>
              <small>
                <img src="https://static.wikitide.net/cravesagawiki/{{ selectedBox.type === 'NORMAL' ? '4/46/Platinum_Gacha_Ticket.png' : 'f/fe/SR_or_Higher_Gacha_Ticket.png' }}" 
                     alt="Ticket" class="ticket-icon-small">
              </small>
            </button>
          </div>

          <div class="ticket-requirement" [class]="openMode === 'multi' ? 'multi-requirement' : ''">
            <i class="bi bi-ticket-perforated-fill"></i>
            <span *ngIf="openMode === 'single'">
              Requer {{ getRequiredTickets().normal + getRequiredTickets().premium }} Ticket{{ getRequiredTickets().normal + getRequiredTickets().premium > 1 ? 's' : '' }}
            </span>
            <span *ngIf="openMode === 'multi'">
              Requer {{ getRequiredTickets().normal || getRequiredTickets().premium }} Ticket{{ (getRequiredTickets().normal || getRequiredTickets().premium) > 1 ? 's' : '' }} {{ selectedBox.type === 'NORMAL' ? 'Normais' : 'Premium' }}
            </span>
          </div>
        </div>

        <!-- Botão para ver taxas de drop -->
        <button class="btn btn-outline-info mb-3" (click)="toggleDropRates()">
          <i class="bi bi-{{ showDropRates ? 'eye-slash' : 'eye' }}"></i>
          {{ showDropRates ? 'Ocultar' : 'Ver' }} Taxas de Drop
        </button>

        <!-- Lista de itens com taxas de drop -->
        <div class="drop-rates-container" *ngIf="showDropRates">
          <h5 class="mb-3"><i class="bi bi-percent"></i> Chances de Drop</h5>
          <div class="drop-rates-list">
            <div class="drop-rate-item" *ngFor="let item of boxItems">
              <img [src]="item.imageUrl" [alt]="item.name" class="drop-item-img">
              <div class="drop-item-info">
                <span class="drop-item-name" [class]="getRarityClass(item.rarity)">{{ item.name }}</span>
                <span class="badge" [class]="getRarityClass(item.rarity)">{{ item.rarity }}</span>
              </div>
              <span class="drop-rate-percentage">{{ (item.dropRate || 0).toFixed(2) }}%</span>
            </div>
          </div>
        </div>

        <button class="btn btn-lg btn-primary open-btn" 
                [disabled]="loading || !hasEnoughTickets()"
                (click)="openBox()">
          <span *ngIf="!loading">
            <i class="bi bi-{{ openMode === 'single' ? 'box-seam' : 'boxes' }}"></i>
            {{ openMode === 'single' ? 'Abrir 1 Caixa' : ('Abrir ' + (selectedBox.type === 'NORMAL' ? '10' : '5') + ' Caixas') }}
          </span>
          <span *ngIf="loading" class="loading-text">
            <i class="bi bi-arrow-repeat"></i> Abrindo...
          </span>
        </button>

        <!-- Modal de Animação do Portal -->
        <div *ngIf="isAnimating" class="portal-animation-overlay">
          <div class="portal-animation-modal">
            <div class="portal-header">
              <h3>Revelando...</h3>
              <div class="portal-subtitle">
                <i class="bi bi-card-text"></i>
                <span>{{ selectedBox.name }}</span>
              </div>
            </div>

            <div class="portal-animation-container">
              <!-- Vídeo ou GIF de abertura personalizado -->
              <div class="custom-opening-animation">
                <video *ngIf="effectiveAnimationType === 'video' && effectiveAnimationSrc" 
                       autoplay 
                       muted 
                       volume="0"
                       playsinline
                       preload="metadata"
                       class="opening-video"
                       (ended)="onAnimationComplete()"
                       (error)="onVideoError()"
                       (loadeddata)="startAnimationTimeout()"
                       (loadedmetadata)="ensureMuted($event)">
                  <source [src]="effectiveAnimationSrc" type="video/mp4">
                  <source [src]="effectiveAnimationSrc!.replace('.mp4', '.webm')" type="video/webm">
                  <source [src]="effectiveAnimationSrc!.replace('.mp4', '.avi')" type="video/avi">
                  Seu navegador não suporta vídeos.
                </video>
                
                <img *ngIf="effectiveAnimationType === 'gif' && effectiveAnimationSrc" 
                     [src]="effectiveAnimationSrc" 
                     alt="Animação de abertura" 
                     class="opening-gif"
                     (load)="onGifLoaded()"
                     (error)="onGifError()">
                     
                <!-- Fallback para quando não há animação específica da caixa -->
                <div *ngIf="!effectiveAnimationSrc" class="animation-fallback">
                  <div class="fallback-spinner">
                    <i class="bi bi-stars text-warning"></i>
                    <div class="fallback-text">Revelando...</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="portal-footer">
              <div class="loading-indicator">
                <i class="bi bi-star-fill text-warning"></i>
                <span class="loading-message">Revelando Itens...</span>
              </div>
              <button class="btn btn-outline-light btn-sm skip-animation-btn" 
                      *ngIf="canSkipAnimation" 
                      (click)="skipAnimation()">
                <i class="bi bi-skip-forward"></i> Pular
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
