rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users: only owner can create/update his own profile (readable by all)
    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false; // deletions should be restricted (admin only) - implement later
    }

    // userItems: readable by everyone, creation allowed only when userId == auth.uid
    // updates allowed if either owner modifies quantity or auth.uid becomes the new owner (transfer to yourself)
    match /userItems/{itemId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      allow update: if request.auth != null && (
        // Owner can update fields but cannot reassign to another user
        resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid
        ||
        // Allow transfer where the new owner is the authenticated user (accepting a trade)
        request.resource.data.userId == request.auth.uid
      );

      allow delete: if false; // deletions restricted
    }

    // trades: anyone authenticated can create a trade where fromUserId == auth.uid and status starts PENDING
    // Only recipient can set status to ACCEPTED/REJECTED, and only sender can cancel
    match /trades/{tradeId} {
      allow create: if request.auth != null
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.status == 'PENDING'
        && request.resource.data.offeredUserItemIds is list
        && request.resource.data.requestedUserItemIds is list;

      allow read: if request.auth != null && (
        resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid
      );

      allow update: if request.auth != null && (
        // recipient can accept/reject
        (resource.data.toUserId == request.auth.uid && request.resource.data.status in ['ACCEPTED','REJECTED'])
        ||
        // sender can cancel
        (resource.data.fromUserId == request.auth.uid && request.resource.data.status == 'CANCELLED')
      );

      allow delete: if false;
    }

    // friends collection (friend requests)
    match /friends/{reqId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || resource.data.friendId == request.auth.uid);
      allow update: if request.auth != null && (resource.data.friendId == request.auth.uid || resource.data.userId == request.auth.uid);
      allow delete: if false;
    }

    // items and other collections default
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}