{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/olimp/OneDrive/Documentos/estagio/Estagio-etapa-3/GachArena/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { environment } from '../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./user.service\";\nimport * as i3 from \"./item.service\";\nexport class RankingService {\n  constructor(http, userService, itemService) {\n    this.http = http;\n    this.userService = userService;\n    this.itemService = itemService;\n  }\n\n  getGlobalRanking() {\n    var _this = this;\n\n    return _asyncToGenerator(function* (limitCount = 50) {\n      try {\n        const rankingEntries = yield _this.http.get(`${environment.backendUrl}/rankings/global/${limitCount}`).toPromise();\n        return rankingEntries || [];\n      } catch (error) {\n        console.error('Erro ao buscar ranking:', error);\n        return [];\n      }\n    }).apply(this, arguments);\n  }\n\n  getRankingByBox(_x) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* (boxId, limitCount = 20) {\n      try {\n        const usersSnapshot = yield getDocs(collection(db, 'users'));\n        const users = usersSnapshot.docs.map(doc => Object.assign({\n          id: doc.id\n        }, doc.data()));\n        const rankingEntries = [];\n\n        for (const user of users) {\n          if (!user.id) continue;\n          const rarestItem = yield _this2.itemService.getUserRarestItemInBox(user.id, boxId);\n          if (!rarestItem) continue;\n          let score = (rarestItem.item.points || 0) + rarestItem.item.power; // Para itens lendários e míticos, multiplicar pelo rarityLevel\n\n          if ((rarestItem.item.rarity === 'LENDARIO' || rarestItem.item.rarity === 'MITICO') && rarestItem.rarityLevel) {\n            const rarityMultiplier = 1 + (1000 - rarestItem.rarityLevel) / 1000; // 1.0 a 2.0\n\n            score = score * rarityMultiplier;\n          } // contar quantos itens o usuário tem nessa caixa\n\n\n          const userItems = yield _this2.itemService.getUserItems(user.id);\n          const itemsInBox = userItems.filter(ui => ui.item.boxId === boxId);\n          const totalItemsInBox = itemsInBox.length;\n          rankingEntries.push({\n            userId: user.id || '',\n            username: user.username || 'Jogador',\n            photoURL: user.profileIcon || user.photoURL || '',\n            profileBackground: user.profileBackground || '',\n            rarestItem: rarestItem,\n            totalItems: totalItemsInBox,\n            score\n          });\n        }\n\n        rankingEntries.sort((a, b) => b.score - a.score);\n        return rankingEntries.slice(0, limitCount);\n      } catch (error) {\n        console.error('Erro ao buscar ranking por caixa:', error);\n        return [];\n      }\n    }).apply(this, arguments);\n  }\n\n}\n\nRankingService.ɵfac = function RankingService_Factory(t) {\n  return new (t || RankingService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.UserService), i0.ɵɵinject(i3.ItemService));\n};\n\nRankingService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: RankingService,\n  factory: RankingService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["C:/Users/olimp/OneDrive/Documentos/estagio/Estagio-etapa-3/GachArena/frontend/src/app/services/ranking.service.ts"],"names":["environment","i0","i1","i2","i3","RankingService","constructor","http","userService","itemService","getGlobalRanking","limitCount","rankingEntries","get","backendUrl","toPromise","error","console","getRankingByBox","boxId","usersSnapshot","getDocs","collection","db","users","docs","map","doc","Object","assign","id","data","user","rarestItem","getUserRarestItemInBox","score","item","points","power","rarity","rarityLevel","rarityMultiplier","userItems","getUserItems","itemsInBox","filter","ui","totalItemsInBox","length","push","userId","username","photoURL","profileIcon","profileBackground","totalItems","sort","a","b","slice","ɵfac","RankingService_Factory","t","ɵɵinject","HttpClient","UserService","ItemService","ɵprov","ɵɵdefineInjectable","token","factory","providedIn"],"mappings":"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","sourcesContent":["import { environment } from '../../environments/environment';\r\nimport * as i0 from \"@angular/core\";\r\nimport * as i1 from \"@angular/common/http\";\r\nimport * as i2 from \"./user.service\";\r\nimport * as i3 from \"./item.service\";\r\nexport class RankingService {\r\n    constructor(http, userService, itemService) {\r\n        this.http = http;\r\n        this.userService = userService;\r\n        this.itemService = itemService;\r\n    }\r\n    async getGlobalRanking(limitCount = 50) {\r\n        try {\r\n            const rankingEntries = await this.http.get(`${environment.backendUrl}/rankings/global/${limitCount}`).toPromise();\r\n            return rankingEntries || [];\r\n        }\r\n        catch (error) {\r\n            console.error('Erro ao buscar ranking:', error);\r\n            return [];\r\n        }\r\n    }\r\n    async getRankingByBox(boxId, limitCount = 20) {\r\n        try {\r\n            const usersSnapshot = await getDocs(collection(db, 'users'));\r\n            const users = usersSnapshot.docs.map(doc => (Object.assign({ id: doc.id }, doc.data())));\r\n            const rankingEntries = [];\r\n            for (const user of users) {\r\n                if (!user.id)\r\n                    continue;\r\n                const rarestItem = await this.itemService.getUserRarestItemInBox(user.id, boxId);\r\n                if (!rarestItem)\r\n                    continue;\r\n                let score = (rarestItem.item.points || 0) + rarestItem.item.power;\r\n                // Para itens lendários e míticos, multiplicar pelo rarityLevel\r\n                if ((rarestItem.item.rarity === 'LENDARIO' || rarestItem.item.rarity === 'MITICO') && rarestItem.rarityLevel) {\r\n                    const rarityMultiplier = 1 + ((1000 - rarestItem.rarityLevel) / 1000); // 1.0 a 2.0\r\n                    score = score * rarityMultiplier;\r\n                }\r\n                // contar quantos itens o usuário tem nessa caixa\r\n                const userItems = await this.itemService.getUserItems(user.id);\r\n                const itemsInBox = userItems.filter((ui) => ui.item.boxId === boxId);\r\n                const totalItemsInBox = itemsInBox.length;\r\n                rankingEntries.push({\r\n                    userId: user.id || '',\r\n                    username: user.username || 'Jogador',\r\n                    photoURL: user.profileIcon || user.photoURL || '',\r\n                    profileBackground: user.profileBackground || '',\r\n                    rarestItem: rarestItem,\r\n                    totalItems: totalItemsInBox,\r\n                    score\r\n                });\r\n            }\r\n            rankingEntries.sort((a, b) => b.score - a.score);\r\n            return rankingEntries.slice(0, limitCount);\r\n        }\r\n        catch (error) {\r\n            console.error('Erro ao buscar ranking por caixa:', error);\r\n            return [];\r\n        }\r\n    }\r\n}\r\nRankingService.ɵfac = function RankingService_Factory(t) { return new (t || RankingService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.UserService), i0.ɵɵinject(i3.ItemService)); };\r\nRankingService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: RankingService, factory: RankingService.ɵfac, providedIn: 'root' });\r\n"]},"metadata":{},"sourceType":"module"}