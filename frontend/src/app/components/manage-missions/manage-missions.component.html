<div class="manage-container">

  <img src="https://i.pinimg.com/originals/1b/3c/58/1b3c5821c4ef798f196b30cc3eb46ac2.gif" class="bg-gif" alt="" aria-hidden="true">
     
  <video autoplay muted loop class="bg-video">
    <source src="assets/backgrounds/welcome.webm" type="video/webm">
    <source src="assets/backgrounds/welcome.mp4" type="video/mp4">
  </video>
    
  <div class="notification-container" *ngIf="notification.show">
    <div class="notification" [ngClass]="notification.type">{{ notification.message }}</div>
  </div>

  <div class="confirmation-container" *ngIf="confirmation.show">
    <div class="confirmation">
      <div class="confirmation-message">{{ confirmation.message }}</div>
      <div class="confirmation-actions">
        <button (click)="confirmDeletion()" class="btn-confirm">Confirmar</button>
        <button (click)="cancelConfirmation()" class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <div class="header">
    <div class="d-flex justify-content-between align-items-center w-100">
      <h1><i class="bi bi-list-task"></i> Gerenciar Miss√µes</h1>
      <button (click)="loadMissions()" class="btn btn-secondary me-2" [disabled]="isLoading" *ngIf="!isEditing">
        <i class="bi bi-arrow-clockwise"></i> Atualizar
      </button>
    </div>
    <div class="create-buttons" *ngIf="!isEditing">
      <button (click)="startCreate('regular')" class="btn-create">+ Nova Miss√£o Regular</button>
      <button (click)="startCreate('daily')" class="btn-create btn-daily">+ Nova Miss√£o Di√°ria</button>
    </div>
  </div>

  <!-- LISTA DE MISS√ïES (quando n√£o est√° editando) -->
  <div class="missions-view" *ngIf="!isEditing">
    
    <!-- Loading -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p>Carregando miss√µes...</p>
    </div>

    <!-- Lista -->
    <div class="missions-list" *ngIf="!isLoading">
      <h2 *ngIf="missions.length > 0">Miss√µes Cadastradas ({{ missions.length }})</h2>
      
      <!-- Empty State -->
      <div class="empty-state" *ngIf="missions.length === 0">
        <i class="bi bi-inbox"></i>
        <h3>Nenhuma miss√£o cadastrada</h3>
        <p>Clique em "Nova Miss√£o" para criar sua primeira miss√£o</p>
      </div>

      <!-- Mission Items -->
      <div class="mission-item" *ngFor="let mission of missions; trackBy: trackByMissionId">
        <div class="mission-info">
          <h3>{{ mission.title || 'Sem t√≠tulo' }}</h3>
          <p>{{ mission.description || 'Sem descri√ß√£o' }}</p>
          <span class="badge">{{ mission.type || 'N/A' }}</span>
          
          <div class="daily-info" *ngIf="mission.type === 'DAILY' && mission.dailyRewards && mission.dailyRewards.length > 0">
            <i class="bi bi-calendar3"></i>
            <span>{{ mission.dailyRewards.length }} dias configurados</span>
          </div>
          
          <div class="rewards-display">
            <div class="reward-item" *ngIf="mission.rewardNormal && mission.rewardNormal > 0">
              <span class="reward-icon">üé´</span>
              <span class="reward-text">{{ mission.rewardNormal }} Normais</span>
            </div>
            <div class="reward-item" *ngIf="mission.rewardPremium && mission.rewardPremium > 0">
              <span class="reward-icon">üíé</span>
              <span class="reward-text">{{ mission.rewardPremium }} Premium</span>
            </div>
          </div>
        </div>
        <div class="mission-actions">
          <button (click)="toggleActive(mission)" [class.active]="mission.active" class="btn-toggle">
            {{ mission.active ? 'Ativa' : 'Inativa' }}
          </button>
          <button (click)="startEdit(mission)" class="btn-edit">Editar</button>
          <button (click)="showDeleteConfirmation(mission)" class="btn-delete">Deletar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FORMUL√ÅRIO EM MODAL -->
  <div class="modal-overlay" *ngIf="isEditing" (click)="cancelEdit()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingMission.type === 'DAILY' ? (editingMission.id ? 'Editar Miss√£o Di√°ria' : 'Nova Miss√£o Di√°ria') : (editingMission.id ? 'Editar Miss√£o' : 'Nova Miss√£o') }}</h2>
        <button class="btn-close-modal" (click)="cancelEdit()"><i class="bi bi-x-lg"></i></button>
      </div>
      
      <div class="modal-body">
        <!-- Miss√£o Regular -->
        <div class="form-content" *ngIf="editingMission.type !== 'DAILY'">
          
          <div class="form-row">
            <div class="form-field full-width">
              <label><i class="bi bi-pencil"></i> T√≠tulo da Miss√£o</label>
              <input [(ngModel)]="editingMission.title" placeholder="Ex: Abrir 10 Caixas Normais" class="input-primary">
            </div>
          </div>

          <div class="form-row">
            <div class="form-field full-width">
              <label><i class="bi bi-text-paragraph"></i> Descri√ß√£o</label>
              <textarea [(ngModel)]="editingMission.description" placeholder="Descreva o objetivo da miss√£o..." rows="3" class="input-primary"></textarea>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field full-width">
              <label><i class="bi bi-bullseye"></i> Tipo de Requisito</label>
              <select [(ngModel)]="editingMission.requirement" class="input-primary">
                <option value="">Selecione um requisito...</option>
                <option value="TOTAL_POWER">Atingir X de Poder Total</option>
                <option value="ITEM_COUNT">Coletar X Itens</option>
                <option value="RARITY_COMMON">Ganhar Item Comum</option>
                <option value="RARITY_RARE">Ganhar Item Raro</option>
                <option value="RARITY_EPIC">Ganhar Item √âpico</option>
                <option value="RARITY_LEGENDARY">Ganhar Item Lend√°rio</option>
                <option value="RARITY_MYTHIC">Ganhar Item M√≠tico</option>
                <option value="OPEN_BOXES">Abrir X Caixas</option>
                <option value="GACHA_PULLS">Fazer X Gachas</option>
                <option value="COMPLETE_TRADES">Completar X Trocas</option>
              </select>
            </div>
          </div>

          <div class="form-row" *ngIf="requiresAmount()">
            <div class="form-field full-width">
              <label><i class="bi bi-123"></i> Quantidade Necess√°ria</label>
              <input type="number" [(ngModel)]="editingMission.requirementAmount" placeholder="Ex: 10, 50, 100..." min="1" class="input-primary">
            </div>
          </div>

          <div class="rewards-section">
            <h3><i class="bi bi-gift"></i> Recompensas</h3>
            <div class="form-row two-cols">
              <div class="form-field reward-field">
                <label>üé´ Tickets Normais</label>
                <input type="number" [(ngModel)]="editingMission.rewardNormal" placeholder="0" min="0" class="input-primary">
              </div>
              <div class="form-field reward-field">
                <label>üíé Tickets Premium</label>
                <input type="number" [(ngModel)]="editingMission.rewardPremium" placeholder="0" min="0" class="input-primary">
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button (click)="saveMission()" class="btn-save-primary">
              <i class="bi bi-check-circle"></i> Salvar Miss√£o
            </button>
            <button (click)="cancelEdit()" class="btn-cancel-secondary">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
          </div>
        </div>

        <!-- Miss√£o Di√°ria -->
        <div class="form-content" *ngIf="editingMission.type === 'DAILY'">
          <div class="form-row">
            <div class="form-field full-width">
              <label><i class="bi bi-pencil"></i> T√≠tulo da Miss√£o Di√°ria</label>
              <input [(ngModel)]="editingMission.title" placeholder="Ex: Recompensas de Login Di√°rio" class="input-primary">
            </div>
          </div>

          <div class="form-row">
            <div class="form-field full-width">
              <label><i class="bi bi-text-paragraph"></i> Descri√ß√£o</label>
              <textarea [(ngModel)]="editingMission.description" placeholder="Fa√ßa login todos os dias para ganhar recompensas progressivas" rows="2" class="input-primary"></textarea>
            </div>
          </div>

          <div class="daily-rewards-editor">
            <h3><i class="bi bi-calendar3"></i> Configurar Dias e Recompensas</h3>
            
            <div class="daily-editor-container">
              <!-- Lista de dias -->
              <div class="daily-days-list">
                <div class="daily-day-card" 
                     *ngFor="let d of (editingMission.dailyRewards || []); let i = index" 
                     [class.selected]="i===selectedDailyIndex" 
                     (click)="selectedDailyIndex = i">
                  <div class="day-number">Dia {{ d.day }}</div>
                  <div class="day-rewards">
                    <span *ngIf="(d.rewardNormal || 0) > 0">üé´ {{ d.rewardNormal }}</span>
                    <span *ngIf="(d.rewardPremium || 0) > 0">üíé {{ d.rewardPremium }}</span>
                  </div>
                  <button class="btn-remove-day" *ngIf="d.day > 1" (click)="removeDailyDay(i); $event.stopPropagation()">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
                <button class="btn-add-day" (click)="addDailyDay()">
                  <i class="bi bi-plus-circle"></i> Adicionar Dia
                </button>
              </div>

              <!-- Editor do dia selecionado -->
              <div class="daily-day-editor" *ngIf="(editingMission.dailyRewards?.length || 0) > 0">
                <h4>Editar Dia {{ selectedDailyReward.day }}</h4>
                
                <div class="form-field">
                  <label><i class="bi bi-tag"></i> R√≥tulo do Dia</label>
                  <input [(ngModel)]="selectedDailyReward.label" placeholder="Ex: Dia 1, Primeiro Dia" class="input-primary" />
                </div>

                <div class="form-row two-cols">
                  <div class="form-field">
                    <label><i class="bi bi-ticket-perforated"></i> Tickets Normais</label>
                    <input type="number" min="0" [(ngModel)]="selectedDailyReward.rewardNormal" class="input-primary" />
                  </div>
                  <div class="form-field">
                    <label><i class="bi bi-gem"></i> Tickets Premium</label>
                    <input type="number" min="0" [(ngModel)]="selectedDailyReward.rewardPremium" class="input-primary" />
                  </div>
                </div>

                <div class="day-actions">
                  <button class="btn-move" (click)="moveDailyUp(selectedDailyIndex)" [disabled]="selectedDailyIndex<=0">
                    <i class="bi bi-arrow-up"></i> Mover para Cima
                  </button>
                  <button class="btn-move" (click)="moveDailyDown(selectedDailyIndex)" [disabled]="selectedDailyIndex>= (editingMission.dailyRewards?.length || 1)-1">
                    <i class="bi bi-arrow-down"></i> Mover para Baixo
                  </button>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button (click)="saveMission()" class="btn-save-primary">
                <i class="bi bi-check-circle"></i> Salvar Miss√£o Di√°ria
              </button>
              <button (click)="cancelEdit()" class="btn-cancel-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
