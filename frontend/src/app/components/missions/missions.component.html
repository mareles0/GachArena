<div class="missions-page">
  <!-- Background -->
  <img src="https://i.pinimg.com/originals/a6/ac/92/a6ac9244c02998a5dcce22c324d8d8a4.gif" class="bg-gif" alt="" aria-hidden="true">
  
  <video autoplay muted loop class="bg-video">
    <source src="assets/backgrounds/welcome.webm" type="video/webm">
    <source src="assets/backgrounds/welcome.mp4" type="video/mp4">
  </video>

  <!-- Notification -->
  <div class="notification-toast" 
       *ngIf="notification.show"
       [class.success]="notification.type === 'success'"
       [class.error]="notification.type === 'error'"
       [class.info]="notification.type === 'info'">
    <i class="bi" 
       [class.bi-check-circle-fill]="notification.type === 'success'"
       [class.bi-x-circle-fill]="notification.type === 'error'"
       [class.bi-info-circle-fill]="notification.type === 'info'"></i>
    <span>{{ notification.message }}</span>
  </div>

  <!-- Header -->
  <div class="missions-header">
    <div class="header-content">
      <h1><i class="bi bi-calendar-check-fill"></i> Missões</h1>
      <p class="subtitle">Complete missões para ganhar recompensas!</p>
    </div>
    
    <div class="filter-buttons">
      <button class="filter-btn" 
              [class.active]="missionFilter === 'all'"
              (click)="missionFilter = 'all'">
        <i class="bi bi-grid-fill"></i> Todas
      </button>
      <button class="filter-btn" 
              [class.active]="missionFilter === 'daily'"
              (click)="missionFilter = 'daily'">
        <i class="bi bi-calendar-check-fill"></i> Diárias
      </button>
      <button class="filter-btn" 
              [class.active]="missionFilter === 'regular'"
              (click)="missionFilter = 'regular'">
        <i class="bi bi-trophy-fill"></i> Regulares
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p>Carregando missões...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading" class="missions-content">
    
    <!-- Missões Diárias -->
    <div *ngIf="dailyUserMissions.length > 0" class="daily-missions-container">
      <div class="daily-mission-panel" *ngFor="let um of dailyUserMissions">
        
        <!-- Header Info -->
        <div class="daily-info-header">
          <div class="info-left">
            <h2>{{ um.mission?.title || 'Recompensas de Login' }}</h2>
            <p>{{ um.mission?.description || 'Faça login diariamente para coletar recompensas' }}</p>
          </div>
          <div class="info-right">
            <div class="days-counter">
              <i class="bi bi-calendar3"></i>
              <span>{{ (um.claimedDays || []).length }} / {{ (um.mission?.dailyRewards || []).length }} Dias</span>
            </div>
          </div>
        </div>

        <!-- Grid de Dias -->
        <div class="days-grid">
          <div class="day-cell" 
               *ngFor="let day of um.mission?.dailyRewards || []"
               [class.claimed]="isDayClaimed(um, day.day)"
               [class.available]="getNextUnclaimedDay(um) === day.day && isDayAvailable(um)"
               [class.locked]="getNextUnclaimedDay(um) !== day.day && !isDayClaimed(um, day.day)">
            
            <div class="day-header">
              <span class="day-number">Dia {{ day.day }}</span>
              <i *ngIf="isDayClaimed(um, day.day)" class="bi bi-check-circle-fill status-icon claimed-icon"></i>
              <i *ngIf="getNextUnclaimedDay(um) === day.day && isDayAvailable(um)" class="bi bi-gift-fill status-icon available-icon"></i>
            </div>

            <div class="day-reward">
              <div *ngIf="day.reward && day.reward.normalTickets && day.reward.normalTickets > 0" class="reward-badge normal">
                <img src="https://static.wikitide.net/cravesagawiki/4/46/Platinum_Gacha_Ticket.png" alt="Ticket">
                <span>×{{ day.reward.normalTickets }}</span>
              </div>
              <div *ngIf="day.reward && day.reward.premiumTickets && day.reward.premiumTickets > 0" class="reward-badge premium">
                <img src="https://static.wikitide.net/cravesagawiki/f/fe/SR_or_Higher_Gacha_Ticket.png" alt="Premium">
                <span>×{{ day.reward.premiumTickets }}</span>
              </div>
            </div>

            <div class="day-action">
              <button *ngIf="getNextUnclaimedDay(um) === day.day && isDayAvailable(um)" 
                      class="btn-claim"
                      (click)="claimDaily(um, day.day)">
                <i class="bi bi-hand-thumbs-up-fill"></i>
                Coletar
              </button>

              <div *ngIf="isDayClaimed(um, day.day)" class="status-label claimed">
                <i class="bi bi-check-lg"></i> Coletado
              </div>

              <div *ngIf="getNextUnclaimedDay(um) === day.day && !isDayAvailable(um)" class="status-label wait">
                <i class="bi bi-clock"></i> {{ timeUntilNext(um) }}
              </div>

              <div *ngIf="getNextUnclaimedDay(um) !== day.day && !isDayClaimed(um, day.day)" class="status-label locked">
                <i class="bi bi-lock-fill"></i>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Missões Disponíveis -->
    <div *ngIf="dailyAvailable.length > 0" class="available-missions">
      <h3><i class="bi bi-plus-circle"></i> Missões Disponíveis</h3>
      <div class="available-grid">
        <div class="available-card" *ngFor="let mission of dailyAvailable" (click)="startMission(mission.id!)">
          <i class="bi bi-calendar-plus-fill mission-icon"></i>
          <h4>{{ mission.title }}</h4>
          <p>{{ mission.description }}</p>
          <button class="btn-start">
            <i class="bi bi-play-fill"></i> Iniciar
          </button>
        </div>
      </div>
    </div>

    <!-- Missões Regulares -->
    <div *ngIf="otherUserMissions.length > 0" class="regular-missions-container">
      <h3><i class="bi bi-trophy-fill"></i> Missões Regulares</h3>
      <div class="regular-missions-grid">
        <div class="regular-mission-card" *ngFor="let um of otherUserMissions">
          <div class="card-header">
            <i [class]="getMissionIcon(um.mission)"></i>
            <h4>{{ um.mission?.title || 'Missão' }}</h4>
          </div>
          <p class="card-description">{{ getMissionDescription(um.mission) }}</p>
          
          <div class="progress-section">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getProgressPercentage(um)"></div>
            </div>
            <span class="progress-text">{{ getProgressPercentage(um) }}%</span>
          </div>

          <div class="card-rewards">
            <div *ngIf="(um.mission?.reward?.normalTickets || 0) > 0" class="reward-item">
              <img src="https://static.wikitide.net/cravesagawiki/4/46/Platinum_Gacha_Ticket.png" alt="Normal">
              <span>×{{ um.mission?.reward?.normalTickets }}</span>
            </div>
            <div *ngIf="(um.mission?.reward?.premiumTickets || 0) > 0" class="reward-item">
              <img src="https://static.wikitide.net/cravesagawiki/f/fe/SR_or_Higher_Gacha_Ticket.png" alt="Premium">
              <span>×{{ um.mission?.reward?.premiumTickets }}</span>
            </div>
          </div>

          <button *ngIf="canClaimMission(um)" 
                  class="btn-claim-mission"
                  (click)="claimReward(um)">
            <i class="bi bi-gift-fill"></i> Resgatar Recompensa
          </button>
          <div *ngIf="um.claimed" class="claimed-badge">
            <i class="bi bi-check-circle-fill"></i> Concluída
          </div>
        </div>
      </div>
    </div>

    <!-- Missões Regulares Disponíveis -->
    <div *ngIf="otherAvailable.length > 0" class="available-missions regular">
      <h3><i class="bi bi-plus-circle"></i> Missões Regulares Disponíveis</h3>
      <div class="available-grid">
        <div class="available-card regular" *ngFor="let mission of otherAvailable" (click)="startMission(mission.id!)">
          <i [class]="getMissionIcon(mission)"></i>
          <h4>{{ mission.title }}</h4>
          <p>{{ getMissionDescription(mission) }}</p>
          <button class="btn-start">
            <i class="bi bi-play-fill"></i> Iniciar
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="dailyUserMissions.length === 0 && dailyAvailable.length === 0 && otherUserMissions.length === 0 && otherAvailable.length === 0 && !isLoading" class="empty-state">
      <i class="bi bi-calendar-x"></i>
      <h3>Nenhuma missão diária disponível</h3>
      <p>Aguarde novas missões serem criadas pelo administrador</p>
    </div>

  </div>
</div>
